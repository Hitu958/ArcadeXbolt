<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logging in... — ArcadeX</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="loading-screen" id="loading">
        <div style="text-align:center">
            <div class="spinner" style="margin:0 auto 20px"></div>
            <h3>Logging you in...</h3>
            <p style="color:var(--text-muted);margin-top:8px" id="status-text">Exchanging token with Discord...</p>
        </div>
    </div>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script>
        (async () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            if (error) {
                document.getElementById('status-text').textContent = 'Login cancelled or failed.';
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            if (!code) {
                document.getElementById('status-text').textContent = 'No authorization code found.';
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            try {
                document.getElementById('status-text').textContent = 'Exchanging code for token...';
                const user = await Auth.fetchUserFromCode(code);
                document.getElementById('status-text').textContent = `Welcome, ${user.global_name || user.username}! Redirecting...`;
                setTimeout(() => window.location.href = '/dashboard.html', 1500);
            } catch (err) {
                console.error('Auth error:', err);
                document.getElementById('status-text').textContent = 'Auth failed — backend not running. See instructions below.';
                document.getElementById('loading').innerHTML = `
          <div style="text-align:center;max-width:500px;padding:20px">
            <div style="font-size:3rem;margin-bottom:16px">⚠️</div>
            <h3>Backend Not Running</h3>
            <p style="color:var(--text-secondary);margin:12px 0">The login flow requires a Node.js backend to exchange the OAuth2 code. Install Node.js first, then run the backend server.</p>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:24px">See the README for setup instructions.</p>
            <a href="index.html" class="btn btn-secondary">← Back to Home</a>
          </div>
        `;
            }
        })();
    </script>
</body>

</html>
